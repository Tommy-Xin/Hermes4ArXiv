.PHONY: help install run clean

help: ## æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
	@echo "ğŸ›ï¸ Hermes4ArXiv - èµ«å°”å¢¨æ–¯æ™ºæ…§ä¿¡ä½¿"
	@echo "å¯ç”¨å‘½ä»¤:"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-20s\033[0m %s\n", $$1, $$2}'

# =============================================================================
# ğŸš€ å¿«é€Ÿå¼€å§‹
# =============================================================================

quick-start: ## ğŸš€ è¿è¡Œå¿«é€Ÿå¼€å§‹å‘å¯¼ï¼ˆæ¨èæ–°ç”¨æˆ·ï¼‰
	@echo "ğŸš€ å¯åŠ¨å¿«é€Ÿå¼€å§‹å‘å¯¼..."
	cd scripts && uv run quick_start.py

setup-local-env: ## ğŸ“ åˆ›å»ºæœ¬åœ°ç¯å¢ƒå˜é‡æ–‡ä»¶
	@if [ ! -f .env ]; then \
		echo "ğŸ“ åˆ›å»ºæœ¬åœ°ç¯å¢ƒå˜é‡æ–‡ä»¶..."; \
		cp env.example .env; \
		echo "âœ… å·²åˆ›å»º .env æ–‡ä»¶ï¼Œè¯·ç¼–è¾‘å¹¶å¡«å…¥æ‚¨çš„é…ç½®ä¿¡æ¯"; \
		echo "ğŸ’¡ æç¤ºï¼šä½¿ç”¨ 'make validate-env' éªŒè¯é…ç½®"; \
	else \
		echo "âš ï¸  .env æ–‡ä»¶å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º"; \
	fi

# =============================================================================
# ğŸ“¦ ä¾èµ–ç®¡ç†
# =============================================================================

install: ## å®‰è£…ä¾èµ–
	uv sync

install-dev: ## å®‰è£…å¼€å‘ä¾èµ–
	uv sync --all-extras --dev

update-deps: ## æ›´æ–°ä¾èµ–
	uv lock --upgrade

# =============================================================================
# ğŸƒ è¿è¡Œç¨‹åº
# =============================================================================

run: ## è¿è¡Œä¸»ç¨‹åº
	cd src && uv run python main.py

test-components: ## è¿è¡Œç»„ä»¶æµ‹è¯•
	cd src && uv run python test_components.py

test-multi-ai: ## æµ‹è¯•å¤šAIåˆ†æå™¨åŠŸèƒ½
	cd src && uv run python test_multi_ai.py

test-quality-evaluation: ## ğŸŒŸ æµ‹è¯•AIè´¨é‡è¯„ä¼°åŠŸèƒ½
	@echo "ğŸ§ª æµ‹è¯•AIè´¨é‡è¯„ä¼°åŠŸèƒ½..."
	@echo "âœ… æµ‹è¯•AIæç¤ºè¯åŒ…å«è´¨é‡è¯„ä¼°ç»´åº¦"
	@echo "âœ… éªŒè¯å…­ç»´åˆ†æä½“ç³»"
	@echo "âœ… æ£€æŸ¥é»˜è®¤è®ºæ–‡æ•°é‡ä¸º50ç¯‡"
	@echo "âœ… ç¡®è®¤è´¨é‡ç­›é€‰é…ç½®å·²ç§»é™¤"
	@echo ""
	@echo "ğŸ’¡ æ–°åŠŸèƒ½è¯´æ˜ï¼š"
	@echo "- æ¯ç¯‡è®ºæ–‡éƒ½æœ‰AIè´¨é‡è¯„ä¼°ï¼ˆè¯„åˆ†+åˆ›æ–°åº¦+ä¸¥è°¨æ€§+å®ç”¨æ€§ï¼‰"
	@echo "- ä¸å†è¿›è¡Œå‰ç«¯ç­›é€‰ï¼Œä¿ç•™æ‰€æœ‰è®ºæ–‡é¿å…é—æ¼"
	@echo "- ç”¨æˆ·å¯åŸºäºAIè¯„ä¼°è‡ªä¸»é€‰æ‹©é˜…è¯»è®ºæ–‡"

# =============================================================================
# ğŸ“§ é‚®ä»¶æ¨¡æ¿é¢„è§ˆ
# =============================================================================

preview-template: ## ç”ŸæˆHTMLé‚®ä»¶æ¨¡æ¿é¢„è§ˆ
	uv run python src/preview_template.py

preview-server: ## å¯åŠ¨HTTPæœåŠ¡å™¨é¢„è§ˆé‚®ä»¶æ¨¡æ¿
	uv run python src/preview_server.py

# =============================================================================
# âš¡ æ€§èƒ½æµ‹è¯•
# =============================================================================

benchmark: ## è¿è¡Œå¹¶è¡Œåˆ†ææ€§èƒ½åŸºå‡†æµ‹è¯•
	uv run scripts/benchmark_parallel.py

benchmark-quick: ## å¿«é€Ÿæ€§èƒ½æµ‹è¯•ï¼ˆ3ç¯‡è®ºæ–‡ï¼‰
	uv run scripts/benchmark_parallel.py --quick

benchmark-full: ## å®Œæ•´æ€§èƒ½æµ‹è¯•ï¼ˆ50ç¯‡è®ºæ–‡ï¼‰
	uv run scripts/benchmark_parallel.py --papers 50

quick-analysis: ## å¿«é€Ÿè®ºæ–‡åˆ†æï¼ˆ5ç¯‡è®ºæ–‡ï¼‰
	uv run scripts/analyze_papers.py --max-papers 5 --search-days 3

# =============================================================================
# ğŸ”§ é…ç½®å’ŒéªŒè¯
# =============================================================================

validate-env: ## éªŒè¯ç¯å¢ƒå˜é‡é…ç½®
	uv run scripts/validate_env.py

validate-env-local: ## ğŸ  æœ¬åœ°ç¯å¢ƒéªŒè¯ï¼ˆè·³è¿‡SMTPæµ‹è¯•ï¼‰
	uv run scripts/validate_env_local.py

validate-v2-upgrade: ## âœ¨ éªŒè¯v2.1è´¨é‡è¯„ä¼°å‡çº§
	@echo "ğŸ” éªŒè¯v2.1è´¨é‡è¯„ä¼°å‡çº§..."
	@echo ""
	@echo "ğŸ“‹ æ£€æŸ¥é…ç½®æ›´æ–°:"
	@grep -q "MAX_PAPERS.*50" src/config.py && echo "âœ… é»˜è®¤è®ºæ–‡æ•°é‡ä¸º50" || echo "âŒ é»˜è®¤è®ºæ–‡æ•°é‡é…ç½®å¼‚å¸¸"
	@grep -q "æ”¹ä¸ºAIåˆ†æé˜¶æ®µè¿›è¡Œè´¨é‡è¯„ä¼°" src/config.py && echo "âœ… è´¨é‡ç­›é€‰é…ç½®å·²ç§»é™¤" || echo "âŒ è´¨é‡ç­›é€‰é…ç½®ä»å­˜åœ¨"
	@echo ""
	@echo "ğŸ“‹ æ£€æŸ¥AIæç¤ºè¯æ›´æ–°:"
	@grep -q "è´¨é‡è¯„ä¼°" src/ai/prompts.py && echo "âœ… AIæç¤ºè¯åŒ…å«è´¨é‡è¯„ä¼°" || echo "âŒ AIæç¤ºè¯ç¼ºå°‘è´¨é‡è¯„ä¼°"
	@grep -q "ç»™å‡ºè®ºæ–‡çš„æ•´ä½“è´¨é‡è¯„åˆ†" src/ai/prompts.py && echo "âœ… åŒ…å«è´¨é‡è¯„åˆ†è¦æ±‚" || echo "âŒ ç¼ºå°‘è´¨é‡è¯„åˆ†è¦æ±‚"
	@echo ""
	@echo "ğŸ“‹ æ£€æŸ¥æ–‡æ¡£æ›´æ–°:"
	@grep -q "å…­ç»´æ·±åº¦è§£è¯»" README.md && echo "âœ… READMEå·²æ›´æ–°ä¸ºå…­ç»´åˆ†æ" || echo "âŒ READMEæœªæ›´æ–°"
	@grep -q "è´¨é‡è¯„ä¼°ä½“ç³»" README.md && echo "âœ… READMEåŒ…å«è´¨é‡è¯„ä¼°ä»‹ç»" || echo "âŒ READMEç¼ºå°‘è´¨é‡è¯„ä¼°ä»‹ç»"
	@echo ""
	@echo "ğŸ‰ v2.1å‡çº§éªŒè¯å®Œæˆï¼"

status: ## æ˜¾ç¤ºé¡¹ç›®çŠ¶æ€æŠ¥å‘Š
	uv run scripts/project_status.py

fix-env-encoding: ## ğŸ”§ ä¿®å¤.envæ–‡ä»¶ä¸­çš„ç¼–ç é—®é¢˜
	uv run scripts/fix_env_encoding.py

# =============================================================================
# ğŸ§¹ æ¸…ç†
# =============================================================================

clean: ## æ¸…ç†ä¸´æ—¶æ–‡ä»¶
	find . -type f -name "*.pyc" -delete
	find . -type d -name "__pycache__" -delete
	find . -type d -name "*.egg-info" -exec rm -rf {} +
	rm -rf build/
	rm -rf dist/
	rm -rf .coverage
	rm -rf htmlcov/
	rm -rf .pytest_cache/
	rm -rf .mypy_cache/

clean-cache: ## æ¸…ç† uv ç¼“å­˜
	uv cache clean

# =============================================================================
# ğŸ“Š ä¿¡æ¯æŸ¥çœ‹
# =============================================================================

show-deps: ## æ˜¾ç¤ºä¾èµ–æ ‘
	uv tree

cache-info: ## æ˜¾ç¤ºç¼“å­˜ä¿¡æ¯
	@echo "ç¼“å­˜ç›®å½•:"
	uv cache dir
	@echo "ç¼“å­˜å†…å®¹:"
	ls -la $$(uv cache dir) 2>/dev/null || echo "ç¼“å­˜ç›®å½•ä¸ºç©º"

python-versions: ## æ˜¾ç¤ºå¯ç”¨çš„ Python ç‰ˆæœ¬
	uv python list 