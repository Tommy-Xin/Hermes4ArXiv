name: ğŸš€ éƒ¨ç½²å¯è¡Œæ€§æµ‹è¯•

on:
  workflow_dispatch:
    inputs:
      setup_type:
        description: 'è®¾ç½®ç±»å‹'
        required: true
        default: 'check_secrets'
        type: choice
        options:
        - check_secrets
        - test_configuration
        - run_analysis

jobs:
  setup-guide:
    runs-on: ubuntu-latest
    steps:
    - name: ğŸ“‹ æ£€æŸ¥é…ç½®çŠ¶æ€
      run: |
        echo "ğŸ” æ£€æŸ¥ DeepSeek AI å’Œé‚®ä»¶é…ç½®çŠ¶æ€..."
        echo ""
        
        # æ£€æŸ¥DeepSeek APIé…ç½® (å¿…éœ€)
        if [ -n "${{ secrets.DEEPSEEK_API_KEY }}" ]; then
          echo "âœ… DEEPSEEK_API_KEY: å·²é…ç½® (ğŸ’° DeepSeek - é«˜æ€§ä»·æ¯”AIåˆ†æ)"
          ai_configured=true
        else
          echo "âŒ DEEPSEEK_API_KEY: æœªé…ç½®"
          ai_configured=false
        fi
        
        if [ "$ai_configured" = false ]; then
          echo "âŒ æœªé…ç½®DeepSeek APIå¯†é’¥"
          secrets_status="missing"
        else
          echo "ğŸ¯ DeepSeek AIé…ç½®å®Œæˆï¼Œç³»ç»Ÿå°†ä½¿ç”¨é«˜æ€§ä»·æ¯”çš„DeepSeekæ¨¡å‹è¿›è¡Œåˆ†æ"
        fi
        
        # æ£€æŸ¥å¿…éœ€çš„é‚®ä»¶é…ç½®
        if [ -z "${{ secrets.SMTP_SERVER }}" ]; then
          echo "âŒ SMTP_SERVER: æœªé…ç½®"
          secrets_status="missing"
        else
          echo "âœ… SMTP_SERVER: å·²é…ç½®"
        fi
        
        if [ -z "${{ secrets.SMTP_USERNAME }}" ]; then
          echo "âŒ SMTP_USERNAME: æœªé…ç½®"
          secrets_status="missing"
        else
          echo "âœ… SMTP_USERNAME: å·²é…ç½®"
        fi
        
        if [ -z "${{ secrets.SMTP_PASSWORD }}" ]; then
          echo "âŒ SMTP_PASSWORD: æœªé…ç½®"
          secrets_status="missing"
        else
          echo "âœ… SMTP_PASSWORD: å·²é…ç½®"
        fi
        
        if [ -z "${{ secrets.EMAIL_FROM }}" ]; then
          echo "âŒ EMAIL_FROM: æœªé…ç½®"
          secrets_status="missing"
        else
          echo "âœ… EMAIL_FROM: å·²é…ç½®"
        fi
        
        if [ -z "${{ secrets.EMAIL_TO }}" ]; then
          echo "âŒ EMAIL_TO: æœªé…ç½®"
          secrets_status="missing"
        else
          echo "âœ… EMAIL_TO: å·²é…ç½®"
        fi
        
        echo ""
        if [ "$secrets_status" = "missing" ]; then
          echo "âš ï¸  å‘ç°ç¼ºå°‘çš„é…ç½®é¡¹ï¼"
          echo ""
          echo "ğŸ“ é…ç½®æ­¥éª¤ï¼š"
          echo "1. è¿›å…¥ä»“åº“ Settings â†’ Secrets and variables â†’ Actions"
          echo "2. ç‚¹å‡» 'New repository secret'"
          echo "3. ğŸ¤– æ·»åŠ DeepSeek AIé…ç½® (å¿…éœ€)ï¼š"
          echo "   ğŸ’° DEEPSEEK_API_KEY: DeepSeek APIå¯†é’¥"
          echo "   ğŸ“– è·å–åœ°å€: https://platform.deepseek.com/"
          echo "4. ğŸ“§ æ·»åŠ é‚®ä»¶é…ç½® (å¿…éœ€)ï¼š"
          echo "   - SMTP_SERVER: é‚®ä»¶æœåŠ¡å™¨ (å¦‚: smtp.gmail.com)"
          echo "   - SMTP_USERNAME: é‚®ç®±è´¦å·"
          echo "   - SMTP_PASSWORD: é‚®ç®±æˆæƒç "
          echo "   - EMAIL_FROM: å‘ä»¶äººé‚®ç®±"
          echo "   - EMAIL_TO: æ”¶ä»¶äººé‚®ç®±"
          echo ""
          echo "ğŸ“– è¯¦ç»†é…ç½®æŒ‡å—: https://github.com/${{ github.repository }}/blob/main/docs/setup/DEEPSEEK_SETUP_GUIDE.md"
          exit 1
        else
          echo "ğŸ‰ é…ç½®éªŒè¯æˆåŠŸï¼DeepSeek AIå’Œé‚®ä»¶é…ç½®å‡å·²å°±ç»ª"
          echo "ğŸ’¡ æç¤º: ç³»ç»Ÿå°†ä½¿ç”¨DeepSeekè¿›è¡Œé«˜è´¨é‡è®ºæ–‡åˆ†æ"
        fi

  test-configuration:
    runs-on: ubuntu-latest
    if: github.event.inputs.setup_type == 'test_configuration'
    needs: setup-guide
    steps:
    - uses: actions/checkout@v4
    
    - name: ğŸ è®¾ç½® Python ç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
    
    - name: ğŸ“¦ å®‰è£… uv
      uses: astral-sh/setup-uv@v3
      with:
        enable-cache: true
    
    - name: ğŸ”§ å®‰è£…ä¾èµ–
      run: uv sync --frozen
    
    - name: ğŸ” éªŒè¯é…ç½®
      env:
        # DeepSeek AIé…ç½®
        DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        DEEPSEEK_MODEL: ${{ secrets.DEEPSEEK_MODEL || 'deepseek-chat' }}
        # é‚®ä»¶é…ç½®
        SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
        SMTP_USERNAME: ${{ secrets.SMTP_USERNAME }}
        SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
        EMAIL_FROM: ${{ secrets.EMAIL_FROM }}
        EMAIL_TO: ${{ secrets.EMAIL_TO }}
        SMTP_PORT: ${{ secrets.SMTP_PORT || '587' }}
      run: |
        echo "ğŸ” è¿è¡Œé…ç½®éªŒè¯å’Œæµ‹è¯•..."
        cd scripts && uv run python validate_env.py

  run-test-analysis:
    runs-on: ubuntu-latest
    if: github.event.inputs.setup_type == 'run_analysis'
    needs: setup-guide
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup uv with retry # Match daily workflow
      id: setup-uv
      continue-on-error: true 
      uses: astral-sh/setup-uv@v4
      with:
        version: "latest"
        enable-cache: true
        cache-dependency-glob: "uv.lock"
    
    - name: Setup uv without cache (fallback) # Match daily workflow
      if: steps.setup-uv.outcome == 'failure'
      uses: astral-sh/setup-uv@v4
      with:
        version: "latest"
        enable-cache: false

    - name: Set up Python # Match daily workflow
      run: uv python install 3.12
    
    - name: ğŸ”§ å®‰è£…ä¾èµ–
      run: uv sync --frozen
    
    - name: ğŸ§ª è¿è¡Œæµ‹è¯•åˆ†æ
      env:
        # DeepSeek AI é…ç½®
        DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        DEEPSEEK_MODEL: ${{ secrets.DEEPSEEK_MODEL || 'deepseek-chat' }}
        
        # è®ºæ–‡æœç´¢é…ç½® (Align with daily, override for test)
        CATEGORIES: ${{ secrets.CATEGORIES || 'cs.AI,cs.LG,cs.CL' }}
        MAX_PAPERS: 3  # Test-specific value
        SEARCH_DAYS: 1 # Test-specific value
        
        # åˆ†æé…ç½® (Align with daily)
        ANALYSIS_TYPE: ${{ secrets.ANALYSIS_TYPE || 'comprehensive' }}
        
        # ğŸ“§ é‚®ä»¶é…ç½® (Align with daily)
        SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
        SMTP_PORT: ${{ secrets.SMTP_PORT || '587' }}
        SMTP_USERNAME: ${{ secrets.SMTP_USERNAME }}
        SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
        EMAIL_FROM: ${{ secrets.EMAIL_FROM }}
        EMAIL_TO: ${{ secrets.EMAIL_TO }}
        
        # ğŸ”§ å¯é€‰é…ç½® (Align with daily)
        GITHUB_REPO_URL: ${{ github.server_url }}/${{ github.repository }}
        
        # âš¡ å¹¶è¡Œå¤„ç†é…ç½® (Align with daily, BATCH_SIZE adjusted for test)
        ENABLE_PARALLEL: ${{ secrets.ENABLE_PARALLEL || 'true' }}
        MAX_WORKERS: ${{ secrets.MAX_WORKERS || '0' }} 
        BATCH_SIZE: ${{ secrets.BATCH_SIZE || '3' }} # Adjusted for MAX_PAPERS=3
        
        # APIé…ç½® (Align with daily)
        API_RETRY_TIMES: ${{ secrets.API_RETRY_TIMES || '3' }}
        API_DELAY: ${{ secrets.API_DELAY || '2' }}
        API_TIMEOUT: ${{ secrets.API_TIMEOUT || '60' }}
      run: |
        echo "ğŸš€ è¿è¡Œæµ‹è¯•åˆ†æï¼ˆå°‘é‡è®ºæ–‡ï¼‰..."
        cd src && uv run python main.py 