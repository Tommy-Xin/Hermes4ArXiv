name: ğŸš€ ä¸€é”®è®¾ç½® ArXiv è®ºæ–‡è¿½è¸ªå™¨

on:
  workflow_dispatch:
    inputs:
      setup_type:
        description: 'è®¾ç½®ç±»å‹'
        required: true
        default: 'check_secrets'
        type: choice
        options:
        - check_secrets
        - test_configuration
        - run_analysis

jobs:
  setup-guide:
    runs-on: ubuntu-latest
    steps:
    - name: ğŸ“‹ æ£€æŸ¥é…ç½®çŠ¶æ€
      run: |
        echo "ğŸ” æ£€æŸ¥å¿…éœ€çš„ Secrets é…ç½®çŠ¶æ€..."
        echo ""
        
        # æ£€æŸ¥å¿…éœ€çš„ Secrets
        secrets_status=""
        
        if [ -z "${{ secrets.DEEPSEEK_API_KEY }}" ]; then
          echo "âŒ DEEPSEEK_API_KEY: æœªé…ç½®"
          secrets_status="missing"
        else
          echo "âœ… DEEPSEEK_API_KEY: å·²é…ç½®"
        fi
        
        if [ -z "${{ secrets.SMTP_SERVER }}" ]; then
          echo "âŒ SMTP_SERVER: æœªé…ç½®"
          secrets_status="missing"
        else
          echo "âœ… SMTP_SERVER: å·²é…ç½®"
        fi
        
        if [ -z "${{ secrets.SMTP_USERNAME }}" ]; then
          echo "âŒ SMTP_USERNAME: æœªé…ç½®"
          secrets_status="missing"
        else
          echo "âœ… SMTP_USERNAME: å·²é…ç½®"
        fi
        
        if [ -z "${{ secrets.SMTP_PASSWORD }}" ]; then
          echo "âŒ SMTP_PASSWORD: æœªé…ç½®"
          secrets_status="missing"
        else
          echo "âœ… SMTP_PASSWORD: å·²é…ç½®"
        fi
        
        if [ -z "${{ secrets.EMAIL_FROM }}" ]; then
          echo "âŒ EMAIL_FROM: æœªé…ç½®"
          secrets_status="missing"
        else
          echo "âœ… EMAIL_FROM: å·²é…ç½®"
        fi
        
        if [ -z "${{ secrets.EMAIL_TO }}" ]; then
          echo "âŒ EMAIL_TO: æœªé…ç½®"
          secrets_status="missing"
        else
          echo "âœ… EMAIL_TO: å·²é…ç½®"
        fi
        
        echo ""
        if [ "$secrets_status" = "missing" ]; then
          echo "âš ï¸  å‘ç°ç¼ºå°‘çš„é…ç½®é¡¹ï¼"
          echo ""
          echo "ğŸ“ é…ç½®æ­¥éª¤ï¼š"
          echo "1. è¿›å…¥ä»“åº“ Settings â†’ Secrets and variables â†’ Actions"
          echo "2. ç‚¹å‡» 'New repository secret'"
          echo "3. æ·»åŠ ä»¥ä¸‹ Secretsï¼š"
          echo "   - DEEPSEEK_API_KEY: æ‚¨çš„ DeepSeek API å¯†é’¥"
          echo "   - SMTP_SERVER: é‚®ä»¶æœåŠ¡å™¨ (å¦‚: smtp.qq.com)"
          echo "   - SMTP_USERNAME: é‚®ç®±è´¦å·"
          echo "   - SMTP_PASSWORD: é‚®ç®±æˆæƒç "
          echo "   - EMAIL_FROM: å‘ä»¶äººé‚®ç®±"
          echo "   - EMAIL_TO: æ”¶ä»¶äººé‚®ç®±"
          echo ""
          echo "ğŸ“– è¯¦ç»†é…ç½®æŒ‡å—: https://github.com/${{ github.repository }}/blob/main/SECRETS_SETUP_GUIDE.md"
          exit 1
        else
          echo "ğŸ‰ æ‰€æœ‰å¿…éœ€çš„ Secrets éƒ½å·²é…ç½®å®Œæˆï¼"
        fi

  test-configuration:
    runs-on: ubuntu-latest
    if: github.event.inputs.setup_type == 'test_configuration'
    needs: setup-guide
    steps:
    - uses: actions/checkout@v4
    
    - name: ğŸ è®¾ç½® Python ç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
    
    - name: ğŸ“¦ å®‰è£… uv
      uses: astral-sh/setup-uv@v3
      with:
        enable-cache: true
    
    - name: ğŸ”§ å®‰è£…ä¾èµ–
      run: uv sync --frozen
    
    - name: ğŸ” éªŒè¯é…ç½®
      env:
        DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
        SMTP_USERNAME: ${{ secrets.SMTP_USERNAME }}
        SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
        EMAIL_FROM: ${{ secrets.EMAIL_FROM }}
        EMAIL_TO: ${{ secrets.EMAIL_TO }}
      run: |
        echo "ğŸ” è¿è¡Œé…ç½®éªŒè¯..."
        uv run scripts/validate_env.py

  run-test-analysis:
    runs-on: ubuntu-latest
    if: github.event.inputs.setup_type == 'run_analysis'
    needs: setup-guide
    steps:
    - uses: actions/checkout@v4
    
    - name: ğŸ è®¾ç½® Python ç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
    
    - name: ğŸ“¦ å®‰è£… uv
      uses: astral-sh/setup-uv@v3
      with:
        enable-cache: true
    
    - name: ğŸ”§ å®‰è£…ä¾èµ–
      run: uv sync --frozen
    
    - name: ğŸ§ª è¿è¡Œæµ‹è¯•åˆ†æ
      env:
        DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
        SMTP_USERNAME: ${{ secrets.SMTP_USERNAME }}
        SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
        EMAIL_FROM: ${{ secrets.EMAIL_FROM }}
        EMAIL_TO: ${{ secrets.EMAIL_TO }}
        MAX_PAPERS: 3  # æµ‹è¯•æ—¶åªåˆ†æ3ç¯‡è®ºæ–‡
        SEARCH_DAYS: 1
      run: |
        echo "ğŸš€ è¿è¡Œæµ‹è¯•åˆ†æï¼ˆå°‘é‡è®ºæ–‡ï¼‰..."
        cd src && uv run python main.py 