name: ğŸš€ ä¸€é”®è®¾ç½® ArXiv è®ºæ–‡è¿½è¸ªå™¨

on:
  workflow_dispatch:
    inputs:
      setup_type:
        description: 'è®¾ç½®ç±»å‹'
        required: true
        default: 'check_secrets'
        type: choice
        options:
        - check_secrets
        - test_configuration
        - run_analysis

jobs:
  setup-guide:
    runs-on: ubuntu-latest
    steps:
    - name: ğŸ“‹ æ£€æŸ¥é…ç½®çŠ¶æ€
      run: |
        echo "ğŸ” æ£€æŸ¥ SOTA AIæ¨¡å‹å’Œé‚®ä»¶é…ç½®çŠ¶æ€..."
        echo ""
        
        # æ£€æŸ¥SOTA AIæ¨¡å‹é…ç½® (è‡³å°‘éœ€è¦ä¸€ä¸ª)
        ai_configured=false
        
        if [ -n "${{ secrets.CLAUDE_API_KEY }}" ]; then
          echo "âœ… CLAUDE_API_KEY: å·²é…ç½® (ğŸ† Claude Opus 4 - ä¸–ç•Œæœ€å¼ºæ¨ç†æ¨¡å‹)"
          ai_configured=true
        fi
        
        if [ -n "${{ secrets.GEMINI_API_KEY }}" ]; then
          echo "âœ… GEMINI_API_KEY: å·²é…ç½® (ğŸ”¬ Gemini 2.5 Pro Preview - Googleæœ€æ–°SOTA)"
          ai_configured=true
        fi
        
        if [ -n "${{ secrets.OPENAI_API_KEY }}" ]; then
          echo "âœ… OPENAI_API_KEY: å·²é…ç½® (ğŸ§  OpenAI o3 - æ¨ç†èƒ½åŠ›ç‹è€…)"
          ai_configured=true
        fi
        
        if [ -n "${{ secrets.DEEPSEEK_API_KEY }}" ]; then
          echo "âœ… DEEPSEEK_API_KEY: å·²é…ç½® (ğŸ’° DeepSeek R1 - é«˜æ€§ä»·æ¯”SOTA)"
          ai_configured=true
        fi
        
        if [ "$ai_configured" = false ]; then
          echo "âŒ æœªé…ç½®ä»»ä½•AI APIå¯†é’¥"
          secrets_status="missing"
        else
          echo "ğŸ¯ AIæ¨¡å‹é…ç½®å®Œæˆï¼Œç³»ç»Ÿå°†è‡ªåŠ¨é€‰æ‹©æœ€ä½³å¯ç”¨æ¨¡å‹"
        fi
        
        # æ£€æŸ¥å¿…éœ€çš„é‚®ä»¶é…ç½®
        secrets_status=""
        
        if [ -z "${{ secrets.SMTP_SERVER }}" ]; then
          echo "âŒ SMTP_SERVER: æœªé…ç½®"
          secrets_status="missing"
        else
          echo "âœ… SMTP_SERVER: å·²é…ç½®"
        fi
        
        if [ -z "${{ secrets.SMTP_USERNAME }}" ]; then
          echo "âŒ SMTP_USERNAME: æœªé…ç½®"
          secrets_status="missing"
        else
          echo "âœ… SMTP_USERNAME: å·²é…ç½®"
        fi
        
        if [ -z "${{ secrets.SMTP_PASSWORD }}" ]; then
          echo "âŒ SMTP_PASSWORD: æœªé…ç½®"
          secrets_status="missing"
        else
          echo "âœ… SMTP_PASSWORD: å·²é…ç½®"
        fi
        
        if [ -z "${{ secrets.EMAIL_FROM }}" ]; then
          echo "âŒ EMAIL_FROM: æœªé…ç½®"
          secrets_status="missing"
        else
          echo "âœ… EMAIL_FROM: å·²é…ç½®"
        fi
        
        if [ -z "${{ secrets.EMAIL_TO }}" ]; then
          echo "âŒ EMAIL_TO: æœªé…ç½®"
          secrets_status="missing"
        else
          echo "âœ… EMAIL_TO: å·²é…ç½®"
        fi
        
        echo ""
        if [ "$secrets_status" = "missing" ]; then
          echo "âš ï¸  å‘ç°ç¼ºå°‘çš„é…ç½®é¡¹ï¼"
          echo ""
          echo "ğŸ“ é…ç½®æ­¥éª¤ï¼š"
          echo "1. è¿›å…¥ä»“åº“ Settings â†’ Secrets and variables â†’ Actions"
          echo "2. ç‚¹å‡» 'New repository secret'"
          echo "3. æ·»åŠ  SOTA AIæ¨¡å‹ API (åªéœ€é…ç½®ä¸€ä¸ª)ï¼š"
          echo "   ğŸ† CLAUDE_API_KEY: Claude Opus 4 APIå¯†é’¥ (æ¨è)"
          echo "   ğŸ”¬ GEMINI_API_KEY: Gemini 2.5 Pro Preview APIå¯†é’¥"
          echo "   ğŸ§  OPENAI_API_KEY: OpenAI o3 APIå¯†é’¥"
          echo "   ğŸ’° DEEPSEEK_API_KEY: DeepSeek R1 APIå¯†é’¥ (ç»æµå‹)"
          echo "4. æ·»åŠ é‚®ä»¶é…ç½®ï¼š"
          echo "   - SMTP_SERVER: é‚®ä»¶æœåŠ¡å™¨ (å¦‚: smtp.gmail.com)"
          echo "   - SMTP_USERNAME: é‚®ç®±è´¦å·"
          echo "   - SMTP_PASSWORD: é‚®ç®±æˆæƒç "
          echo "   - EMAIL_FROM: å‘ä»¶äººé‚®ç®±"
          echo "   - EMAIL_TO: æ”¶ä»¶äººé‚®ç®±"
          echo ""
          echo "ğŸ“– è¯¦ç»†é…ç½®æŒ‡å—: https://github.com/${{ github.repository }}/blob/main/SECRETS_SETUP_GUIDE.md"
          exit 1
        else
          echo "ğŸ‰ æ‰€æœ‰å¿…éœ€çš„ Secrets éƒ½å·²é…ç½®å®Œæˆï¼"
        fi

  test-configuration:
    runs-on: ubuntu-latest
    if: github.event.inputs.setup_type == 'test_configuration'
    needs: setup-guide
    steps:
    - uses: actions/checkout@v4
    
    - name: ğŸ è®¾ç½® Python ç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
    
    - name: ğŸ“¦ å®‰è£… uv
      uses: astral-sh/setup-uv@v3
      with:
        enable-cache: true
    
    - name: ğŸ”§ å®‰è£…ä¾èµ–
      run: uv sync --frozen
    
    - name: ğŸ” éªŒè¯é…ç½®
      env:
        # SOTA AIæ¨¡å‹é…ç½®
        CLAUDE_API_KEY: ${{ secrets.CLAUDE_API_KEY }}
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        # é‚®ä»¶é…ç½®
        SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
        SMTP_USERNAME: ${{ secrets.SMTP_USERNAME }}
        SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
        EMAIL_FROM: ${{ secrets.EMAIL_FROM }}
        EMAIL_TO: ${{ secrets.EMAIL_TO }}
        SMTP_PORT: ${{ secrets.SMTP_PORT }}
      run: |
        echo "ğŸ” è¿è¡Œé…ç½®éªŒè¯å’Œæµ‹è¯•..."
        cd scripts && uv run validate_env.py

  run-test-analysis:
    runs-on: ubuntu-latest
    if: github.event.inputs.setup_type == 'run_analysis'
    needs: setup-guide
    steps:
    - uses: actions/checkout@v4
    
    - name: ğŸ è®¾ç½® Python ç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
    
    - name: ğŸ“¦ å®‰è£… uv
      uses: astral-sh/setup-uv@v3
      with:
        enable-cache: true
    
    - name: ğŸ”§ å®‰è£…ä¾èµ–
      run: uv sync --frozen
    
    - name: ğŸ§ª è¿è¡Œæµ‹è¯•åˆ†æ
      env:
        # SOTA AIæ¨¡å‹é…ç½®
        CLAUDE_API_KEY: ${{ secrets.CLAUDE_API_KEY }}
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        # é‚®ä»¶é…ç½®
        SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
        SMTP_USERNAME: ${{ secrets.SMTP_USERNAME }}
        SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
        EMAIL_FROM: ${{ secrets.EMAIL_FROM }}
        EMAIL_TO: ${{ secrets.EMAIL_TO }}
        # æµ‹è¯•é…ç½®
        MAX_PAPERS: 3  # æµ‹è¯•æ—¶åªåˆ†æ3ç¯‡è®ºæ–‡
        SEARCH_DAYS: 1
      run: |
        echo "ğŸš€ è¿è¡Œæµ‹è¯•åˆ†æï¼ˆå°‘é‡è®ºæ–‡ï¼‰..."
        cd src && uv run python main.py 