name: ğŸ“° Daily Paper Analysis

on:
  schedule:
    - cron: '0 0 * * *'  # æ¯å¤© UTC æ—¶é—´ 00:00 è¿è¡Œï¼ˆåŒ—äº¬æ—¶é—´ 08:00ï¼‰
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  analyze-papers:
    runs-on: ubuntu-latest
    timeout-minutes: 90  # å¢åŠ è¶…æ—¶æ—¶é—´ä»¥åº”å¯¹ç½‘ç»œå»¶è¿Ÿ
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    # åˆ†æ­¥éª¤å¤„ç†ç¼“å­˜ï¼Œå¢åŠ å®¹é”™æ€§
    - name: Setup uv with retry
      id: setup-uv
      continue-on-error: true
      uses: astral-sh/setup-uv@v4
      with:
        version: "latest"
        enable-cache: true
        cache-dependency-glob: "uv.lock"
    
    # å¦‚æœç¼“å­˜å¤±è´¥ï¼Œä½¿ç”¨æ— ç¼“å­˜æ¨¡å¼
    - name: Setup uv without cache (fallback)
      if: steps.setup-uv.outcome == 'failure'
      uses: astral-sh/setup-uv@v4
      with:
        version: "latest"
        enable-cache: false
    
    - name: Set up Python
      run: uv python install 3.12
    
    # å°è¯•æ¢å¤papersç¼“å­˜ï¼Œå¤±è´¥ä¸å½±å“ä¸»æµç¨‹
    - name: Restore papers cache
      id: cache-papers
      continue-on-error: true
      uses: actions/cache/restore@v4
      with:
        path: src/papers
        key: ${{ runner.os }}-papers-${{ hashFiles('**/uv.lock') }}
        restore-keys: |
          ${{ runner.os }}-papers-
    
    - name: Install dependencies with retry
      run: |
        echo "å¼€å§‹å®‰è£…ä¾èµ–..."
        for i in {1..3}; do
          echo "å°è¯•ç¬¬ $i æ¬¡å®‰è£…ä¾èµ–..."
          if timeout 300 uv sync --frozen; then
            echo "âœ… ä¾èµ–å®‰è£…æˆåŠŸ"
            break
          else
            echo "âŒ ä¾èµ–å®‰è£…å¤±è´¥ï¼Œç¬¬ $i æ¬¡é‡è¯•..."
            if [ $i -lt 3 ]; then
              echo "ç­‰å¾… 15 ç§’åé‡è¯•..."
              sleep 15
            else
              echo "âŒ ä¾èµ–å®‰è£…æœ€ç»ˆå¤±è´¥"
              exit 1
            fi
          fi
        done
    
    - name: Create necessary directories
      run: |
        mkdir -p src/papers
        mkdir -p src/templates
        mkdir -p src/logs
        echo "ğŸ“ åˆ›å»ºå¿…è¦ç›®å½•å®Œæˆ"
    
    - name: Run paper analysis with timeout
      timeout-minutes: 45  # ä¸ºä¸»è¦ä»»åŠ¡è®¾ç½®ç‹¬ç«‹è¶…æ—¶
      env:
        # DeepSeek AI é…ç½®
        DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        DEEPSEEK_MODEL: ${{ secrets.DEEPSEEK_MODEL || 'deepseek-chat' }}
        
        # è®ºæ–‡æœç´¢é…ç½®
        CATEGORIES: ${{ secrets.CATEGORIES || 'cs.AI,cs.LG,cs.CL' }}
        MAX_PAPERS: ${{ secrets.MAX_PAPERS || '50' }}
        SEARCH_DAYS: ${{ secrets.SEARCH_DAYS || '2' }}
        
        # åˆ†æé…ç½®  
        ANALYSIS_TYPE: ${{ secrets.ANALYSIS_TYPE || 'comprehensive' }}
        
        # ğŸ“§ é‚®ä»¶é…ç½®
        SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
        SMTP_PORT: ${{ secrets.SMTP_PORT || '587' }}
        SMTP_USERNAME: ${{ secrets.SMTP_USERNAME }}
        SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
        EMAIL_FROM: ${{ secrets.EMAIL_FROM }}
        EMAIL_TO: ${{ secrets.EMAIL_TO }}
        
        # ğŸ”§ å¯é€‰é…ç½®
        GITHUB_REPO_URL: ${{ github.server_url }}/${{ github.repository }}
        
        # âš¡ å¹¶è¡Œå¤„ç†é…ç½®
        ENABLE_PARALLEL: ${{ secrets.ENABLE_PARALLEL || 'true' }}
        MAX_WORKERS: ${{ secrets.MAX_WORKERS || '0' }}  # 0è¡¨ç¤ºè‡ªåŠ¨è®¡ç®—
        BATCH_SIZE: ${{ secrets.BATCH_SIZE || '20' }}
        
        # APIé…ç½®
        API_RETRY_TIMES: ${{ secrets.API_RETRY_TIMES || '3' }}
        API_DELAY: ${{ secrets.API_DELAY || '2' }}
        API_TIMEOUT: ${{ secrets.API_TIMEOUT || '60' }}
      run: |
        echo "ğŸš€ å¼€å§‹è®ºæ–‡åˆ†æ..."
        cd src
        timeout 2700 uv run python main.py  # 45åˆ†é’Ÿè¶…æ—¶
        echo "âœ… è®ºæ–‡åˆ†æå®Œæˆ"
    
    # å°è¯•ä¿å­˜papersç¼“å­˜ï¼Œå¤±è´¥ä¸å½±å“ä¸»æµç¨‹
    - name: Save papers cache
      if: always()
      continue-on-error: true
      uses: actions/cache/save@v4
      with:
        path: src/papers
        key: ${{ runner.os }}-papers-${{ hashFiles('**/uv.lock') }}
    
    - name: Upload logs as artifacts
      if: always()  # å³ä½¿å¤±è´¥ä¹Ÿä¸Šä¼ æ—¥å¿—
      continue-on-error: true  # ä¸Šä¼ å¤±è´¥ä¸å½±å“ä¸»æµç¨‹
      uses: actions/upload-artifact@v4
      with:
        name: logs-${{ github.run_number }}
        path: src/logs/
        retention-days: 7
        if-no-files-found: warn
    
    - name: Commit and push changes
      if: success()  # åªæœ‰æˆåŠŸæ—¶æ‰æäº¤
      run: |
        echo "ğŸ“ å‡†å¤‡æäº¤æ›´æ”¹..."
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
        git add src/conclusion.md src/logs/ || true
        
        if git diff --staged --quiet; then
          echo "ğŸ“„ æ²¡æœ‰æ›´æ”¹éœ€è¦æäº¤"
        else
          echo "ğŸ“š æäº¤è®ºæ–‡åˆ†æç»“æœ..."
          git commit -m "ğŸ“š Update paper analysis for $(date +'%Y-%m-%d %H:%M')"
          
          # é‡è¯•æ¨é€æœºåˆ¶
          for i in {1..3}; do
            if git push; then
              echo "âœ… æ¨é€æˆåŠŸ"
              break
            else
              echo "âŒ æ¨é€å¤±è´¥ï¼Œç¬¬ $i æ¬¡é‡è¯•..."
              if [ $i -lt 3 ]; then
                sleep 5
                git pull --rebase
              else
                echo "âŒ æ¨é€æœ€ç»ˆå¤±è´¥"
                exit 1
              fi
            fi
          done
        fi
    
    - name: Performance summary
      if: always()
      run: |
        echo "ğŸ“Š æ€§èƒ½æ€»ç»“ï¼š"
        echo "- å·¥ä½œæµè¿è¡Œæ—¶é—´: ${{ github.event.head_commit.timestamp }}"
        echo "- ç¼“å­˜çŠ¶æ€: ${{ steps.cache-papers.outputs.cache-hit && 'å‘½ä¸­' || 'æœªå‘½ä¸­' }}"
        echo "- è¿è¡ŒçŠ¶æ€: ${{ job.status }}"
        
        # æ˜¾ç¤ºèµ„æºä½¿ç”¨æƒ…å†µ
        echo "ğŸ’¾ ç£ç›˜ä½¿ç”¨æƒ…å†µ:"
        df -h
        echo "ğŸ§  å†…å­˜ä½¿ç”¨æƒ…å†µ:"
        free -h
    
    - name: Notify on failure
      if: failure()
      run: |
        echo "âŒ å·¥ä½œæµæ‰§è¡Œå¤±è´¥"
        echo "ğŸ• å¤±è´¥æ—¶é—´: $(date)"
        echo "ğŸ” å¯èƒ½çš„åŸå› ï¼š"
        echo "  1. DeepSeek API å¤±è´¥ - æ£€æŸ¥APIå¯†é’¥å’Œé…é¢"
        echo "  2. ç½‘ç»œè¿æ¥é—®é¢˜æˆ–è¶…æ—¶"
        echo "  3. é‚®ä»¶é…ç½®é”™è¯¯"
        echo "  4. ArXivæœåŠ¡ä¸å¯ç”¨"
        echo "  5. GitHub Actionsç¼“å­˜æœåŠ¡å¼‚å¸¸"
        echo ""
        echo "ğŸ’¡ å»ºè®®è§£å†³æ–¹æ¡ˆï¼š"
        echo "  - æ£€æŸ¥DeepSeek APIå¯†é’¥æœ‰æ•ˆæ€§å’Œä½™é¢"
        echo "  - ç™»å½• https://platform.deepseek.com/ æŸ¥çœ‹è´¦æˆ·çŠ¶æ€"
        echo "  - æ‰‹åŠ¨é‡æ–°è¿è¡Œå·¥ä½œæµ"
        echo "  - æŸ¥çœ‹è¯¦ç»†æ—¥å¿—äº†è§£å…·ä½“é”™è¯¯"
        echo "  - ç¡®è®¤é‚®ä»¶SMTPé…ç½®æ­£ç¡®"
        echo ""